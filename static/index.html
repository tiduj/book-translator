<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Translator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card.blue { background: #e3f2fd; }
        .stat-card.green { background: #e8f5e9; }
        .stat-card.purple { background: #f3e5f5; }
        .stat-card.gray { background: #f5f5f5; }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #333;
        }

        .stat-card.blue .stat-value { color: #1976d2; }
        .stat-card.green .stat-value { color: #388e3c; }
        .stat-card.purple .stat-value { color: #7b1fa2; }
        .stat-card.gray .stat-value { color: #424242; }

        /* Main Card */
        .main-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .header {
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 0.95rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #333;
            border-bottom-color: #2196f3;
            font-weight: 500;
        }

        .tab:hover {
            color: #333;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #2196f3;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
            background: #fafafa;
        }

        .upload-section:hover {
            border-color: #2196f3;
            background: #f5f9ff;
        }

        .upload-section.dragover {
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #999;
        }

        .upload-section h3 {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .upload-section p {
            font-size: 0.85rem;
            color: #999;
        }

        .file-input {
            display: none;
        }

        /* Button */
        .btn-translate {
            width: 100%;
            padding: 14px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-translate:hover {
            background: #1976d2;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 12px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-export:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-export:active {
            transform: translateY(0);
        }

        .btn-translate:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Text Panels */
        .text-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .text-panel {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            min-height: 300px;
        }

        .text-panel h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .text-panel-content {
            font-size: 0.85rem;
            line-height: 1.7;
            color: #555;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .text-panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .text-panel-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        /* Progress */
        .progress-section {
            display: none;
            margin-top: 20px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: #2196f3;
            transition: width 0.3s;
        }

        .progress-info {
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }

        /* History */
        .history-item {
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .history-item-meta {
            font-size: 0.8rem;
            color: #999;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-in-progress {
            background: #fff3e0;
            color: #e65100;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        .btn-small {
            padding: 6px 14px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-small:hover {
            background: #1976d2;
        }

        .selected-file {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
            color: #1976d2;
        }

        .selected-file.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card blue">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value" id="successRate">100.0%</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Avg Translation Time</div>
                <div class="stat-value" id="avgTime">86.1s</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">CPU Usage</div>
                <div class="stat-value" id="cpuUsage">10.6%</div>
            </div>
            <div class="stat-card gray">
                <div class="stat-label">Memory Usage</div>
                <div class="stat-value" id="memoryUsage">55.8%</div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="main-card">
            <div class="header">
                <h1>Book Translator</h1>
                <p>Translate your books and large documents</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('new')">New Translation</button>
                <button class="tab" onclick="switchTab('history')">Translation History</button>
            </div>

            <!-- New Translation Tab -->
            <div class="tab-content active" id="newTranslationTab">
                <form id="translationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sourceLanguage">Source Language</label>
                            <select id="sourceLanguage" required>
                                <option value="en">English</option>
                                <option value="ru">Russian</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="targetLanguage">Target Language</label>
                            <select id="targetLanguage" required>
                                <option value="ru">Russian</option>
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="model">Select Model</label>
                            <select id="model" required>
                                <option value="">‚è≥ Loading models...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="genre">Text Genre</label>
                            <select id="genre" required>
                                <option value="unknown">Unknown / Auto</option>
                                <option value="fiction">Fiction / Novel</option>
                                <option value="technical">Technical</option>
                                <option value="academic">Academic</option>
                                <option value="business">Business</option>
                                <option value="poetry">Poetry</option>
                            </select>
                        </div>
                    </div>

                    <div class="selected-file" id="selectedFile">
                        <span id="selectedFileName"></span>
                    </div>

                    <div class="upload-section" id="uploadSection">
                        <div class="upload-icon">‚òÅÔ∏è</div>
                        <h3>Click to upload or drag and drop</h3>
                        <p>TXT files only (max 10MB)</p>
                        <input type="file" id="fileInput" class="file-input" accept=".txt" required>
                    </div>

                    <button type="submit" class="btn-translate" id="translateBtn">
                        Start Translation
                    </button>

                    <div class="progress-section" id="progressSection">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-info" id="progressInfo">Initializing...</div>
                    </div>

                    <div class="text-panels">
                        <div class="text-panel">
                            <h3>Original Text</h3>
                            <div class="text-panel-content" id="originalText">
                                No content yet
                            </div>
                        </div>
                        <div class="text-panel">
                            <h3>Stage 1: Primary Translation</h3>
                            <div class="text-panel-content" id="machineTranslation">
                                No content yet
                            </div>
                        </div>
                        <div class="text-panel">
                            <h3>Stage 2: Self-Reflection</h3>
                            <div class="text-panel-content" id="literaryRefinement">
                                No content yet
                            </div>
                        </div>
                    </div>

                    <!-- Export Buttons -->
                    <div class="export-buttons" id="exportButtons" style="display: none;">
                        <button type="button" class="btn-export" onclick="copyToClipboard()">
                            Copy to Clipboard
                        </button>
                        <button type="button" class="btn-export" onclick="saveAsTxt()">
                            Save as TXT
                        </button>
                        <button type="button" class="btn-export" onclick="saveAsPdf()">
                            Save as PDF
                        </button>
                        <button type="button" class="btn-export" onclick="saveAsEpub()">
                            Save as EPUB
                        </button>
                    </div>
                </form>
            </div>

            <!-- Translation History Tab -->
            <div class="tab-content" id="historyTab">
                <div id="historyList">
                    <p style="text-align: center; color: #999; padding: 40px;">No translations yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001';
        let selectedFile = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            loadTranslations();
            loadStats();
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            uploadSection.addEventListener('click', () => fileInput.click());

            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            document.getElementById('translationForm').addEventListener('submit', handleSubmit);
        }

        function handleFileSelect(file) {
            selectedFile = file;
            document.getElementById('selectedFileName').textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
            document.getElementById('selectedFile').classList.add('show');
            
            // Clear previous translation results
            document.getElementById('machineTranslation').textContent = 'No content yet';
            document.getElementById('literaryRefinement').textContent = 'No content yet';
            
            // Hide export buttons and progress section
            document.getElementById('exportButtons').style.display = 'none';
            
            const progressSection = document.getElementById('progressSection');
            if (progressSection) {
                progressSection.style.display = 'none';
            }
            
            // Reset progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            
            // Read and display file content
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('originalText').textContent = content;
                console.log('File loaded, length:', content.length);
            };
            reader.onerror = function(e) {
                console.error('Error reading file:', e);
                document.getElementById('originalText').textContent = 'Error reading file';
            };
            reader.readAsText(file);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function loadModels() {
            const modelSelect = document.getElementById('model');
            try {
                console.log('Fetching models from:', `${API_URL}/models`);
                const response = await fetch(`${API_URL}/models?t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    cache: 'no-cache'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                
                if (!data.models || data.models.length === 0) {
                    throw new Error('No models available');
                }
                
                modelSelect.innerHTML = data.models.map(model => 
                    `<option value="${model.name}">${model.name}</option>`
                ).join('');

                const statValue = document.getElementById('availableModels');
                if (statValue) {
                    statValue.textContent = data.models.length;
                }
                
                console.log(`‚úì Loaded ${data.models.length} models successfully`);
            } catch (error) {
                console.error('‚úó Error loading models:', error);
                if (modelSelect) {
                    modelSelect.innerHTML = `<option value="">‚ùå ${error.message}</option>`;
                }
                const statValue = document.getElementById('availableModels');
                if (statValue) {
                    statValue.textContent = '0';
                }
            }
        }

        async function loadStats() {
            try {
                const metricsResponse = await fetch(`${API_URL}/metrics`);
                const data = await metricsResponse.json();
                
                const tm = data.translation_metrics;
                const sm = data.system_metrics;
                
                // Update stats
                const successRate = tm.success_rate || 100.0;
                document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
                document.getElementById('avgTime').textContent = (tm.average_translation_time || 0).toFixed(1) + 's';
                document.getElementById('cpuUsage').textContent = (sm.cpu_percent || 0).toFixed(1) + '%';
                document.getElementById('memoryUsage').textContent = (sm.memory_percent || 0).toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            
            if (tab === 'new') {
                tabs[0].classList.add('active');
                document.getElementById('newTranslationTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                loadTranslations();
            }
        }

        async function loadTranslations() {
            try {
                const response = await fetch(`${API_URL}/translations`);
                const data = await response.json();
                
                const historyList = document.getElementById('historyList');
                
                if (data.translations.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #999;">No translations yet</p>';
                    return;
                }

                historyList.innerHTML = data.translations.slice(0, 10).map(t => `
                    <div class="history-item">
                        <div class="history-item-info">
                            <div class="history-item-title">
                                <span class="status-badge status-${t.status}">${t.status}</span>
                                ${t.filename || 'Unknown'}
                            </div>
                            <div class="history-item-meta">
                                ${t.source_lang} ‚Üí ${t.target_lang} | ${new Date(t.created_at).toLocaleString()}
                                ${t.progress ? ` | ${t.progress.toFixed(0)}%` : ''}
                            </div>
                        </div>
                        ${t.status === 'completed' ? 
                            `<button class="btn btn-small" onclick="downloadTranslation(${t.id})">‚¨á Download</button>` : 
                            t.status === 'error' ? 
                            `<button class="btn btn-small" onclick="retryTranslation(${t.id})">üîÑ Retry</button>` : 
                            ''
                        }
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading translations:', error);
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // Get text from textarea or file
            const textArea = document.getElementById('textInput');
            const textContent = textArea ? textArea.value.trim() : '';
            
            let fileToUpload = selectedFile;
            
            // If no file selected but text is entered, create a file from text
            if (!fileToUpload && textContent) {
                const blob = new Blob([textContent], { type: 'text/plain' });
                fileToUpload = new File([blob], 'pasted_text.txt', { type: 'text/plain' });
            }
            
            if (!fileToUpload && !textContent) {
                alert('Please select a file or enter text');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileToUpload);
            formData.append('sourceLanguage', document.getElementById('sourceLanguage').value);
            formData.append('targetLanguage', document.getElementById('targetLanguage').value);
            formData.append('model', document.getElementById('model').value);
            formData.append('genre', document.getElementById('genre').value);

            const translateBtn = document.getElementById('translateBtn');
            const progressSection = document.getElementById('progressSection');
            
            translateBtn.disabled = true;
            progressSection.style.display = 'block';

            try {
                const response = await fetch(`${API_URL}/translate`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Translation failed');
                }

                // Parse stream to get translation ID and results
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let lastData = null;
                
                // Show indeterminate progress
                document.getElementById('progressBar').style.width = '50%';
                document.getElementById('progressInfo').textContent = 'Translating...';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6).trim());
                                lastData = data;
                                
                                // Update UI with actual data
                                if (data.progress) {
                                    document.getElementById('progressBar').style.width = data.progress + '%';
                                    document.getElementById('progressInfo').textContent = 
                                        `${data.stage || 'Processing'} - ${Math.round(data.progress)}%`;
                                }
                                
                                if (data.original_text) {
                                    document.getElementById('originalText').textContent = data.original_text;
                                }
                                if (data.machine_translation) {
                                    document.getElementById('machineTranslation').textContent = data.machine_translation;
                                }
                                if (data.translated_text) {
                                    document.getElementById('literaryRefinement').textContent = data.translated_text;
                                }
                            } catch (e) {
                                // Ignore JSON errors, continue
                            }
                        }
                    }
                }
                
                // Translation complete
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressInfo').textContent = 'Completed!';

                alert('Translation completed successfully!');
                document.getElementById('exportButtons').style.display = 'flex';
                loadTranslations();
            } catch (error) {
                console.error('Error:', error);
                alert('Translation failed: ' + error.message);
            } finally {
                translateBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressInfo = document.getElementById('progressInfo');

            progressBar.style.width = data.progress + '%';
            
            progressInfo.textContent = `${data.stage} - Chunk ${data.current_chunk}/${data.total_chunks}`;
            
            // Update text panels
            if (data.original_text) {
                document.getElementById('originalText').textContent = data.original_text;
            }
            if (data.machine_translation) {
                document.getElementById('machineTranslation').textContent = data.machine_translation;
            }
            if (data.translated_text) {
                document.getElementById('literaryRefinement').textContent = data.translated_text;
            }
        }

        function resetForm() {
            document.getElementById('translationForm').reset();
            document.getElementById('selectedFile').classList.remove('show');
            selectedFile = null;
        }

        async function downloadTranslation(id) {
            window.location.href = `${API_URL}/download/${id}`;
        }

        async function retryTranslation(id) {
            if (!confirm('Retry this translation?')) return;

            try {
                const response = await fetch(`${API_URL}/retry-translation/${id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Translation retry initiated');
                    loadTranslations();
                } else {
                    alert('Failed to retry translation');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error retrying translation');
            }
        }

        // Export functions
        function copyToClipboard() {
            const text = document.getElementById('literaryRefinement').textContent;
            if (text === 'No content yet') {
                alert('No translation to copy');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úì Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        function saveAsTxt() {
            const text = document.getElementById('literaryRefinement').textContent;
            if (text === 'No content yet') {
                alert('No translation to save');
                return;
            }
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `translation_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function saveAsPdf() {
            const text = document.getElementById('literaryRefinement').textContent;
            if (text === 'No content yet') {
                alert('No translation to save');
                return;
            }
            
            // Split by double newlines to get paragraphs
            const paragraphs = text.split('\n\n').filter(p => p.trim());
            const htmlParagraphs = paragraphs.map(p => {
                // Replace single newlines with <br> within paragraphs
                const formatted = p.trim().replace(/\n/g, '<br>');
                return `<p>${formatted}</p>`;
            }).join('\n');
            
            // Create a simple HTML for PDF
            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Georgia, serif; 
            line-height: 1.8; 
            padding: 40px; 
            max-width: 800px; 
            margin: 0 auto; 
            color: #333;
        }
        h1 { 
            font-size: 24px; 
            margin-bottom: 30px; 
            color: #000;
        }
        p { 
            margin-bottom: 1.5em; 
            text-align: justify;
            text-indent: 2em;
        }
        p:first-of-type {
            text-indent: 0;
        }
    </style>
</head>
<body>
    <h1>Translation Result</h1>
    ${htmlParagraphs}
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `translation_${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('HTML file saved. Open it in a browser and use Print > Save as PDF');
        }

        async function saveAsEpub() {
            const text = document.getElementById('literaryRefinement').textContent;
            if (text === 'No content yet') {
                alert('No translation to save');
                return;
            }
            
            // Prompt for title
            const title = prompt('Enter book title:', 'Translated Book') || 'Translated Book';
            const author = prompt('Enter author name:', 'Unknown Author') || 'Unknown Author';
            
            try {
                const response = await fetch(`${API_URL}/export/epub`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        title: title,
                        author: author
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create EPUB');
                }
                
                // Download the EPUB file
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-z0-9]/gi, '_')}.epub`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úì EPUB file created successfully!');
            } catch (error) {
                console.error('EPUB export error:', error);
                alert('Failed to create EPUB: ' + error.message);
            }
        }

        // Auto-refresh stats and translations
        setInterval(() => {
            loadStats();
            loadTranslations();
        }, 5000);
    </script>
</body>
</html> 